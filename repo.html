<h1>チェス定石トレーナー：Lichess対局の定石分析システム</h1>
<p><strong>学籍番号</strong>: [23FR036]<br><strong>氏名</strong>: [加藤 将貴]</p>
<hr>
<h2>1. はじめに</h2>
<h3>1.1 背景</h3>
<p>[TODO: 以下のような内容を自分の言葉で書く]</p>
<ul>
<li>チェスの上達には定石（オープニング）の学習が不可欠</li>
<li>自分の対局のどこで定石から外れたか気づきにくい</li>
<li>既存ツールは高額または機能が限定的</li>
</ul>
<h4>チェスの定石トレーナーを作成した理由について</h4>
<p>将棋が趣味で将棋をやっていたら似たルールのチェスも<br>少しだけ指せるようになった．<br>そのため，チェスはあまり好きではないが，負けたくない．<br>勝つための努力はせずにチェスでも勝ちたい．<br>序盤さえ互角で進めることができれば，将棋で培った読みの力でゲームに勝つことができる．<br>序盤を互角で進めるためには，定石の暗記が不可欠であるため，序盤の勉強を楽にするためのアプリを作成した．</p>
<h3>1.2 目的</h3>
<p>本プログラムは，Lichess（オンラインチェスプラットフォーム）で行われた対局を分析し，<br>プレイヤーが定石から外れた箇所を検出して学習を支援することを目的とする．</p>
<h3>1.3 概要</h3>
<p>本システムは以下の機能を提供する：</p>
<ul>
<li>Lichess APIから対局データを取得</li>
<li>Opening Explorer APIから定石データを取得</li>
<li>プレイヤーの手が定石内か判定（100ゲーム以上を閾値とする）</li>
<li>定石外れの場合，正しい定石手と相手の最善手を提示</li>
<li>定石手順を最大15手まで表示</li>
</ul>
<hr>
<h2>2. プログラムで使用するデータとデータ記述言語</h2>
<h3>2.1 Web API</h3>
<p>本プログラムは3つのWeb APIを利用している．</p>
<h4>2.1.1 Lichess API</h4>
<p>プレイヤーの対局データを取得するためのAPI．NDJSON形式でゲーム情報を返す．</p>
<h4>2.1.2 Opening Explorer API</h4>
<p>チェスの定石データベース．特定の局面における各手の統計情報（指された回数，勝率など）をJSON形式で提供する．</p>
<h4>2.1.3 Chess Engine API</h4>
<p>チェスエンジンを利用して，特定局面での最善手を計算するAPI．</p>
<h3>2.2 データ記述言語とフォーマット</h3>
<h4>JSON (JavaScript Object Notation)</h4>
<p>全てのAPIレスポンスはJSON形式で提供される．軽量で可読性が高く，JavaのGsonライブラリで容易にパースできる．</p>
<h4>SAN (Standard Algebraic Notation)</h4>
<p>チェスの手を表記する標準形式（例：<code>Nf3</code>, <code>e4</code>, <code>O-O</code>）．人間にとって読みやすい．</p>
<h4>FEN (Forsyth-Edwards Notation)</h4>
<p>チェス盤の局面を1行の文字列で表現する形式．局面の保存・復元に使用．</p>
<hr>
<h2>3. プログラムの設計と実装</h2>
<h3>3.1 実現した機能</h3>
<h4>3.1.1 基本機能</h4>
<ol>
<li><strong>対局データの取得</strong>: Lichessユーザー名を指定して最新の対局を取得(デフォルトは自分のユーザー名であるdef-e)</li>
<li><strong>プレイヤーカラーの自動検出</strong>: 対局データから白番・黒番を自動判別</li>
<li><strong>定石判定</strong>: 各手が定石か判定</li>
<li><strong>定石外れの検出</strong>: 最初に定石から外れた手を特定</li>
<li><strong>推奨手の表示</strong>: 定石外れ時に正しい定石手を提示</li>
<li><strong>咎められる手表示</strong>: 相手がどう対応すべきかを表示</li>
<li><strong>定石手順の表示</strong>: 対局の定石部分を最大15手まで表示</li>
</ol>
<h4>3.1.2 高度な機能</h4>
<ul>
<li><strong>定石範囲外と定石外れの区別</strong><ul>
<li>定石外れ：定石が存在するのに別の手を指した</li>
<li>定石範囲外：その局面に定石が存在しない（100ゲーム以上の手がない）</li>
</ul>
</li>
</ul>
<h4>3.1.3 使用方法</h4>
<pre><code class="language-bash"># コンパイル
mvn clean compile

# 実行（ユーザー名を指定）
mvn exec:java -Dexec.mainClass=&quot;jp.ac.dendai.App&quot; -Dexec.args=&quot;[username]&quot;

# 実行例
mvn exec:java -Dexec.mainClass=&quot;jp.ac.dendai.App&quot; -Dexec.args=&quot;def-e&quot;
</code></pre>
<h4>3.1.4 前提条件と制約</h4>
<ul>
<li>インターネット接続が必要（API利用のため）</li>
<li>分析対象はLichessの公開対局のみ</li>
<li>定石判定は100ゲーム以上を閾値とする</li>
<li>最大で最初の15手（チェスの数え方，白番と黒番の手セットで1手）のみを分析対象とする</li>
</ul>
<h3>3.2 システムが利用するリソース</h3>
<p>リソース1: Lichess Games API<br>名称: Lichess Games Export API<br>概要: ユーザーの対局データをエクスポートするAPI<br>利用目的: 対局データの取得<br>URL: <a href="https://lichess.org/api/games/user/%7Busername%7D">https://lichess.org/api/games/user/{username}</a><br>形式: Web API (NDJSON形式)<br>リクエストパラメータ:</p>
<ul>
<li>username: Lichessユーザー名（パスパラメータ）</li>
<li>opeing: オープニング情報を含める</li>
</ul>
<p>レスポンス構造:</p>
<ul>
<li>形式: NDJSON (Newline Delimited JSON)</li>
<li>各行が1つのゲームオブジェクトを表すJSON</li>
<li>主要フィールド:<ul>
<li>id: ゲームID</li>
<li>players: プレイヤー情報（white/black、user、rating）</li>
<li>moves: 指し手の列（SAN形式、スペース区切り）</li>
<li>opening: オープニング情報（eco、name、ply）</li>
<li>clock: 持ち時間設定</li>
<li>status: ゲーム終了状態</li>
<li>winner: 勝者の色</li>
</ul>
</li>
</ul>
<pre><code class="language-JSON">{&quot;id&quot;:&quot;tVyiD7v5&quot;,&quot;rated&quot;:true,&quot;variant&quot;:&quot;standard&quot;,&quot;speed&quot;:&quot;blitz&quot;,&quot;perf&quot;:&quot;blitz&quot;,&quot;createdAt&quot;:1766986122983,&quot;lastMoveAt&quot;:1766986736483,&quot;status&quot;:&quot;resign&quot;,&quot;source&quot;:&quot;pool&quot;,&quot;players&quot;:{&quot;white&quot;:{&quot;user&quot;:{&quot;name&quot;:&quot;icedmilktea&quot;,&quot;id&quot;:&quot;icedmilktea&quot;},&quot;rating&quot;:1427,&quot;ratingDiff&quot;:4},&quot;black&quot;:{&quot;user&quot;:{&quot;name&quot;:&quot;def-e&quot;,&quot;id&quot;:&quot;def-e&quot;},&quot;rating&quot;:1378,&quot;ratingDiff&quot;:-14}},&quot;winner&quot;:&quot;white&quot;,&quot;opening&quot;:{&quot;eco&quot;:&quot;D02&quot;,&quot;name&quot;:&quot;Queen&#39;s Pawn Game: Symmetrical Variation, Pseudo-Catalan&quot;,&quot;ply&quot;:5},&quot;moves&quot;:&quot;d4 d5 Nf3 Nf6 g3 e6 Bg2 Bd6 O-O O-O c4 dxc4 Nc3 a6 e4 Bb4 Bg5 h6 Bxf6 Qxf6 e5 Qd8 Nd2 Qxd4 Rc1 Nc6 Nf3 Qxd1 Rfxd1 Bxc3 Rxc3 Na5 a4 b5 axb5 axb5 Ra3 b4 Ra4 Bd7 Rxd7 c3 Rxb4 c2 Rxc7 Nc4 Rbxc4 Ra1+ Bf1 Rd8 Rxc2 Rdd1 Nd2&quot;,&quot;clock&quot;:{&quot;initial&quot;:300,&quot;increment&quot;:3,&quot;totalTime&quot;:420}}
</code></pre>
<p>リソース2: Opening Explorer API<br>名称: Lichess Opening Explorer API<br>概要: チェス定石データベース．局面ごとの手の統計を提供<br>利用目的: 各局面での定石手とゲーム数の取得<br>URL: <a href="https://explorer.lichess.ovh/lichess">https://explorer.lichess.ovh/lichess</a><br>形式: Web API (JSON形式)</p>
<p>リクエストパラメータ:</p>
<ul>
<li>variant: ゲームバリアント（デフォルト: standard）</li>
<li>speeds: タイムコントロール（カンマ区切り、例: blitz,rapid,classical）</li>
<li>ratings: レーティング範囲（カンマ区切り、例: 1600,1800,2000,2200,2500）</li>
<li>play: 現在の局面までの手順（UCI形式、カンマ区切り、例: e2e4,e7e5）</li>
</ul>
<p>レスポンス構造:</p>
<ul>
<li>形式: JSON</li>
<li>主要フィールド:<ul>
<li>white: 白勝利のゲーム数</li>
<li>draws: 引き分けのゲーム数</li>
<li>black: 黒勝利のゲーム数</li>
<li>moves: この局面から可能な手の配列<ul>
<li>uci: UCI形式の手</li>
<li>san: SAN形式の手</li>
<li>averageRating: この手が指された対局の平均レーティング</li>
<li>white/draws/black: この手における白勝利/引き分け/黒勝利のゲーム数</li>
<li>opening: オープニング情報（eco、name）</li>
</ul>
</li>
<li>recentGames: 最近の対局のサンプル</li>
<li>opening: 現在の局面のオープニング情報</li>
</ul>
</li>
</ul>
<pre><code class="language-JSON">{&quot;white&quot;:250702783,&quot;draws&quot;:21910923,&quot;black&quot;:220445454,&quot;moves&quot;:[{&quot;uci&quot;:&quot;g1f3&quot;,&quot;san&quot;:&quot;Nf3&quot;,&quot;averageRating&quot;:1836,&quot;white&quot;:161214378,&quot;draws&quot;:14787883,&quot;black&quot;:141595436,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C40&quot;,&quot;name&quot;:&quot;King&#39;s Knight Opening&quot;}},{&quot;uci&quot;:&quot;f1c4&quot;,&quot;san&quot;:&quot;Bc4&quot;,&quot;averageRating&quot;:1789,&quot;white&quot;:24827664,&quot;draws&quot;:2077492,&quot;black&quot;:22392779,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C23&quot;,&quot;name&quot;:&quot;Bishop&#39;s Opening&quot;}},{&quot;uci&quot;:&quot;f2f4&quot;,&quot;san&quot;:&quot;f4&quot;,&quot;averageRating&quot;:1840,&quot;white&quot;:23213554,&quot;draws&quot;:1602798,&quot;black&quot;:20085641,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C30&quot;,&quot;name&quot;:&quot;King&#39;s Gambit&quot;}},{&quot;uci&quot;:&quot;d2d4&quot;,&quot;san&quot;:&quot;d4&quot;,&quot;averageRating&quot;:1837,&quot;white&quot;:15358140,&quot;draws&quot;:1122647,&quot;black&quot;:12423983,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;Center Game&quot;}},{&quot;uci&quot;:&quot;b1c3&quot;,&quot;san&quot;:&quot;Nc3&quot;,&quot;averageRating&quot;:1842,&quot;white&quot;:14410523,&quot;draws&quot;:1236777,&quot;black&quot;:12273113,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C25&quot;,&quot;name&quot;:&quot;Vienna Game&quot;}},{&quot;uci&quot;:&quot;d2d3&quot;,&quot;san&quot;:&quot;d3&quot;,&quot;averageRating&quot;:1761,&quot;white&quot;:4189072,&quot;draws&quot;:408439,&quot;black&quot;:4274470,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: Leonardis Variation&quot;}},{&quot;uci&quot;:&quot;d1h5&quot;,&quot;san&quot;:&quot;Qh5&quot;,&quot;averageRating&quot;:1743,&quot;white&quot;:1729664,&quot;draws&quot;:156850,&quot;black&quot;:1550308,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: Wayward Queen Attack&quot;}},{&quot;uci&quot;:&quot;c2c3&quot;,&quot;san&quot;:&quot;c3&quot;,&quot;averageRating&quot;:1788,&quot;white&quot;:1574481,&quot;draws&quot;:129747,&quot;black&quot;:1518942,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: MacLeod Attack&quot;}},{&quot;uci&quot;:&quot;d1f3&quot;,&quot;san&quot;:&quot;Qf3&quot;,&quot;averageRating&quot;:1722,&quot;white&quot;:971065,&quot;draws&quot;:87905,&quot;black&quot;:959904,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: Napoleon Attack&quot;}},{&quot;uci&quot;:&quot;c2c4&quot;,&quot;san&quot;:&quot;c4&quot;,&quot;averageRating&quot;:1815,&quot;white&quot;:833206,&quot;draws&quot;:84003,&quot;black&quot;:787154,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;English Opening: The Whale&quot;}},{&quot;uci&quot;:&quot;g2g3&quot;,&quot;san&quot;:&quot;g3&quot;,&quot;averageRating&quot;:1806,&quot;white&quot;:570977,&quot;draws&quot;:52103,&quot;black&quot;:549309,&quot;game&quot;:null,&quot;opening&quot;:null},{&quot;uci&quot;:&quot;b2b3&quot;,&quot;san&quot;:&quot;b3&quot;,&quot;averageRating&quot;:1766,&quot;white&quot;:347361,&quot;draws&quot;:30938,&quot;black&quot;:392430,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Opening&quot;}}],&quot;recentGames&quot;:[{&quot;uci&quot;:&quot;g1f3&quot;,&quot;id&quot;:&quot;pQNSVFp5&quot;,&quot;winner&quot;:null,&quot;speed&quot;:&quot;rapid&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;Para85&quot;,&quot;rating&quot;:1912},&quot;white&quot;:{&quot;name&quot;:&quot;gg264&quot;,&quot;rating&quot;:1927},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;},{&quot;uci&quot;:&quot;f1c4&quot;,&quot;id&quot;:&quot;ijErMjCS&quot;,&quot;winner&quot;:&quot;white&quot;,&quot;speed&quot;:&quot;blitz&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;NurikTurganbek&quot;,&quot;rating&quot;:1999},&quot;white&quot;:{&quot;name&quot;:&quot;Yarlaxle&quot;,&quot;rating&quot;:1972},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;},{&quot;uci&quot;:&quot;g1f3&quot;,&quot;id&quot;:&quot;tcSaFYFc&quot;,&quot;winner&quot;:&quot;black&quot;,&quot;speed&quot;:&quot;blitz&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;lunamarta&quot;,&quot;rating&quot;:1963},&quot;white&quot;:{&quot;name&quot;:&quot;Jovudza&quot;,&quot;rating&quot;:1916},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;},{&quot;uci&quot;:&quot;g1f3&quot;,&quot;id&quot;:&quot;BqwxwJ0t&quot;,&quot;winner&quot;:&quot;white&quot;,&quot;speed&quot;:&quot;classical&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;rezav&quot;,&quot;rating&quot;:1708},&quot;white&quot;:{&quot;name&quot;:&quot;goscpiotrek&quot;,&quot;rating&quot;:1830},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;}],&quot;topGames&quot;:[],&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game&quot;}}
</code></pre>
<p>リソース3: Chess Engine API<br>名称: Chess-API.com<br>概要: チェスエンジンによる局面評価・最善手計算<br>利用目的: 定石外れ後の相手の最善手を取得（咎められてしまう手の計算）<br>URL: <a href="https://chess-api.com/v1">https://chess-api.com/v1</a><br>形式: Web API (JSON形式)<br>リクエストパラメータ:</p>
<ul>
<li>fen: 局面のFEN表記（必須）</li>
<li>depth: 探索深度（最大18、デフォルト12）</li>
<li>variants: 評価する変化手数（最大5、デフォルト1）</li>
<li>maxThinkingTime: 最大思考時間（最大100ms、デフォルト50ms）</li>
</ul>
<p>レスポンス構造:</p>
<ul>
<li>形式: JSON</li>
<li>主要フィールド:<ul>
<li>type: レスポンスタイプ（move / bestmove / info）</li>
<li>eval: 評価値（負の値は黒有利）</li>
<li>move: 最善手（UCI形式）</li>
<li>san: 最善手（SAN形式）</li>
<li>depth: 探索深度</li>
<li>continuationArr: 推奨される続きの手順</li>
<li>mate: 詰みまでの手数（nullまたは整数）</li>
<li>winChance: 勝率（0-100%）</li>
<li>text: 評価の説明文</li>
</ul>
</li>
</ul>
<pre><code class="language-JSON">{
  &quot;text&quot;: &quot;Move e2 → e4 (e4): [0.29]. The game is balanced. Depth 12.&quot;,
  &quot;captured&quot;: false,
  &quot;promotion&quot;: false,
  &quot;isCapture&quot;: false,
  &quot;isPromotion&quot;: false,
  &quot;isCastling&quot;: false,
  &quot;fen&quot;: &quot;rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1&quot;,
  &quot;type&quot;: &quot;bestmove&quot;,
  &quot;depth&quot;: 12,
  &quot;move&quot;: &quot;e2e4&quot;,
  &quot;eval&quot;: 0.29,
  &quot;centipawns&quot;: &quot;29&quot;,
  &quot;mate&quot;: null,
  &quot;continuationArr&quot;: [
    &quot;e7e5&quot;,
    &quot;g1f3&quot;,
    &quot;b8c6&quot;,
    &quot;d2d4&quot;,
    &quot;e5d4&quot;,
    &quot;f3d4&quot;,
    &quot;g8f6&quot;,
    &quot;d4c6&quot;,
    &quot;b7c6&quot;,
    &quot;f1d3&quot;,
    &quot;d7d5&quot;,
    &quot;e4e5&quot;,
    &quot;f6d7&quot;
  ],
  &quot;debug&quot;: &quot;info depth 12 seldepth 26 multipv 1 score cp 29 nodes 334092 nps 30372000 hashfull 16 tbhits 0 time 11 pv e2e4 e7e5 g1f3 b8c6 d2d4 e5d4 f3d4 g8f6 d4c6 b7c6 f1d3 d7d5 e4e5 f6d7&quot;,
  &quot;winChance&quot;: 52.66697440308632,
  &quot;taskId&quot;: &quot;yo6lt5tc1&quot;,
  &quot;turn&quot;: &quot;w&quot;,
  &quot;color&quot;: &quot;w&quot;,
  &quot;piece&quot;: &quot;p&quot;,
  &quot;from&quot;: &quot;e2&quot;,
  &quot;to&quot;: &quot;e4&quot;,
  &quot;san&quot;: &quot;e4&quot;,
  &quot;flags&quot;: &quot;b&quot;,
  &quot;lan&quot;: &quot;e2e4&quot;,
  &quot;fromNumeric&quot;: &quot;52&quot;,
  &quot;toNumeric&quot;: &quot;54&quot;,
  &quot;continuation&quot;: [
    {
      &quot;from&quot;: &quot;e7&quot;,
      &quot;to&quot;: &quot;e5&quot;,
      &quot;fromNumeric&quot;: &quot;57&quot;,
      &quot;toNumeric&quot;: &quot;55&quot;
    },
    {
      &quot;from&quot;: &quot;g1&quot;,
      &quot;to&quot;: &quot;f3&quot;,
      &quot;fromNumeric&quot;: &quot;71&quot;,
      &quot;toNumeric&quot;: &quot;63&quot;
    }
  ]
}
</code></pre>
<h3>3.3 プログラムの構成</h3>
<h4>3.3.1 全体構成</h4>
<p>本プログラムは単一のJavaアプリケーションとして構成され，以下の3層構造を持つ：</p>
<p>APIクライアント層: 外部APIとの通信を担当<br>サービス層: ロジック（定石分析）を実装<br>表示層: 分析結果の表示を担当<br>[App.java] (メインクラス・表示)<br>    ↓<br>[OpeningTrainerService] (分析ロジック)<br>    ↓                ↓                    ↓<br>[LichessApiClient] [OpeningExplorerClient] [ChessEngineClient]</p>
<h4>3.3.2 主要クラスとその役割</h4>
<p>APIクライアント層:</p>
<ul>
<li>LichessApiClient: Lichess APIから対局データを取得</li>
<li>OpeningExplorerClient: Opening Explorer APIから定石データを取得</li>
<li>ChessEngineClient: Chess Engine APIから最善手を取得</li>
</ul>
<p>サービス層:</p>
<ul>
<li>OpeningTrainerService: 定石分析のメインロジック<br>analyzeGame(): 対局を分析し，各手が定石内か判定<br>getOpeningTheoryLine(): 定石手順を15手まで取得</li>
</ul>
<p>ユーティリティ層:</p>
<ul>
<li>PositionTracker: チェス盤の状態管理<br>手の適用，FEN取得，UCI変換などを担当<br>データモデル層:</li>
</ul>
<p>Game: 対局データのモデル<br>MoveAnalysis: 各手の分析結果を格納<br>OpeningResponse, OpeningMove: Opening APIレスポンスのモデル<br>EngineResponse: Engine APIレスポンスのモデル<br>メイン層:</p>
<p>App: エントリーポイント．結果表示を担当<br>3.3.3 クラス図<br>[TODO: 以下のようなクラス図を描く]</p>
<p>┌─────────────────┐<br>│      App        │<br>│  + main()       │<br>└────────┬────────┘<br>         │<br>         ↓<br>┌─────────────────────────┐<br>│ OpeningTrainerService   │<br>│ - explorerClient        │<br>│ - engineClient          │<br>│ + analyzeGame()         │<br>│ + getOpeningTheoryLine()│<br>└──────┬──────────────────┘<br>       │<br>       ├─→ LichessApiClient<br>       ├─→ OpeningExplorerClient<br>       ├─→ ChessEngineClient<br>       └─→ PositionTracker</p>
<p>3.3.4 外部ライブラリ<br>Gson (com.google.code.gson): JSON解析に使用<br>chesslib (com.github.bhlangonijr.chesslib): チェスボードの状態管理，手の適用・検証に使用</p>
<h3>3.4 データ構造とアルゴリズム</h3>
<h4>3.4.1 データ構造</h4>
<ol>
<li>MoveAnalysis（手の分析結果）</li>
</ol>
<pre><code class="language-java">class MoveAnalysis {
    int moveNumber;              // 手番
    boolean isWhite;             // 白番か
    String playedMove;           // 実際に指された手
    boolean isOpeningMove;       // 定石内か
    boolean isOutOfTheory;       // 定石範囲外か
    List&lt;OpeningMove&gt; topOpeningMoves;  // 定石手のリスト
    String recommendedMove;      // 推奨手
    String punishmentMove;       // 罰手
}
</code></pre>
<ol start="2">
<li>PositionTracker（局面管理）</li>
</ol>
<p>内部にBoardオブジェクト（chesslibライブラリ）を保持<br>手の履歴をスタック構造で管理<br>FEN・UCI変換機能を提供<br>3. OpeningMove（定石手の統計）</p>
<pre><code class="language-java">class OpeningMove {
    String san;        // SAN表記
    String uci;        // UCI表記
    long white;        // 白勝利数
    long draws;        // 引き分け数
    long black;        // 黒勝利数
    int averageRating; // 平均レーティング
    
    long getTotalGames() {
        return white + draws + black;
    }
}
</code></pre>
<p>使用したデータ型の選択理由:</p>
<p>long型: Opening Explorerのゲーム数は21億を超えるため，intではオーバーフローする<br>List<OpeningMove>: 定石手は複数あり，順序が重要（人気順）なためリストを使用<br>booleanフラグ: 定石内/範囲外の状態を明確に区別<br>3.4.2 アルゴリズム</p>
<ol>
<li>定石判定アルゴリズム</li>
</ol>
<p>定石判定(局面, 指された手):<br>    1. Opening Explorer APIから局面の定石データを取得<br>    2. 100ゲーム以上の手のみをフィルタリング<br>    3. フィルタ結果が空の場合:<br>        → 定石範囲外と判定<br>        → 解析終了<br>    4. フィルタ結果に指された手が含まれる場合:<br>        → 定石内と判定<br>        → 次の手へ<br>    5. フィルタ結果に指された手が含まれない場合:<br>        → 定石外れと判定<br>        → 推奨手 = フィルタ結果の1番目（最多ゲーム数）<br>        → 解析終了</p>
<p>計算量: O(n × m)</p>
<p>n: 分析する手数（最大15手）<br>m: 各局面の定石手候補数（通常5-10手程度）</p>
<h4>2 定石手順取得アルゴリズム</h4>
<p>定石手順取得(開始手順):<br>    1. 開始手順を適用（実際に指された定石内の手）<br>    2. 定石リストに開始手順を追加<br>    3. 30ply（15手）に達するまで繰り返し:<br>        a. 現在局面の定石データを取得<br>        b. 100ゲーム以上の手をフィルタ<br>        c. フィルタ結果が空なら終了<br>        d. 最多ゲーム数の手を選択<br>        e. 手を適用し，定石リストに追加<br>    4. 定石リストを返す</p>
<p>特徴:</p>
<p>貪欲法: 各局面で最多ゲーム数の手を選択<br>実際の対局との整合性: 開始手順を使うことで，対局と定石の整合性を取っている．<br>3.4.3 定石判定の閾値<br>定石として認める基準を100ゲーム以上と設定した理由：</p>
<p>指された手が100回未満の手はおそらく定石外の手であるため．<br>定石であったら全世界のプレイヤーがその定石を知らず，<br>データベースに100回も指されたことが記録されないなんてことはないだろうと考えたため．<br>100回以上指される局面は頻繁に現れる局面だと考え，頻繫現れる局面は<br>定石と考えてよいだろうと判断したため．</p>
<h3>3.5 その他の工夫点</h3>
<h4>3.5.1 数値オーバーフロー対策</h4>
<p>Opening Explorer APIのゲーム数は最大35億を超える場合があり，Java のint型（最大21億）では表現できない．<br>そのためlong型（最大922京）を使用した．</p>
<h4>3.5.2 プレイヤーカラー自動検出</h4>
<p>ユーザーが白番・黒番のどちらで対局したかを自動判別することで，<br>ユーザビリティを向上させた．</p>
<h4>3.5.3 定石外れと定石範囲外の区別</h4>
<p>定石外れ: ユーザーのミス → 学習すべき箇所<br>定石範囲外: 定石が尽きた → ミスではない<br>この区別により，ユーザーは自分の責任範囲を明確に理解できる．</p>
<h4>3.5.4 Top Opening Movesのフィルタリング</h4>
<p>100ゲーム以上の手のみを表示（最大3個）することで，信頼性の高い情報のみを提供．</p>
<ol start="4">
<li>実験<br>4.1 実験条件<br>実行環境:<br>Java: 17<br>Maven: [TODO: バージョン]<br>Gson: 2.10.1<br>chesslib: 1.3.3</li>
</ol>
<p>ユーザー名: def-e<br>対局数: 1（最新対局）<br>対局形式: ブリッツ/ラピッド/クラシカル（全て含む）<br>分析範囲: 開始から15手（30ply）</p>
<p>4.2 実験結果<br>4.2.1 成功例：定石範囲外の検出</p>
<pre><code class="language-bash">=== Chess Opening Trainer ===
Fetching games for user: def-e

Game ID: tVyiD7v5
Opening: Queen&#39;s Pawn Game: Symmetrical Variation

White: icedmilktea (1427)
Black: def-e (1378)

Analyzing black moves for def-e

=== Opening Analysis Results ===

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Move 9... Black: h6
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ℹ️  Opening theory ends here
   (No moves with 100+ games in this position)

⚔️ Opponent&#39;s best response to your move:
   Bh4

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Summary:
  Opening followed: 8 moves
  Result: Reached end of theory
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📖 Opening Sequence (Theory):

   1. d4 d5
   2. Nf3 Nf6
   3. g3 e6
   4. Bg2 Bd6
   5. O-O O-O
   6. c4 dxc4
   7. Nc3 a6
   8. e4 Bb4

   (定石は8手目までです)
</code></pre>
<p>結果の解釈:</p>
<p>8手目まで定石通りに指している<br>9手目で定石が尽きた（100ゲーム以上の手が存在しない）<br>これはユーザーのミスではなく，定石の終わり<br>相手の最善応手（Bh4）は参考情報として表示</p>
<ol start="5">
<li>考察<br>5.1 機能<br>5.1.1 実現した機能の評価<br>本プログラムは当初の目的である「定石外れの検出と学習支援」を達成できた．特に以下の点で有効である：</li>
</ol>
<p>長所:</p>
<p>短所:<br>定石外れの深刻度（どれだけ悪手か）が示されない</p>
<p>5.1.2 改良案<br>深刻度の評価: エンジン評価値を使い小さなミスと大きなミスを区別<br>定石の傾向分析: 複数の対局を分析し，よく外れる箇所を統計的に提示<br>定石の幅を表示: 2番手，3番手の定石手も提示し，定石の柔軟性を示す</p>
<p>5.2 実現方法<br>5.2.1 プログラム構造の評価<br>3層構造（APIクライアント / サービス / 表示）の採用は適切だった．責任の分離により，各層の変更が他層に影響しにくくなっている．</p>
<p>良かった点:</p>
<p>API変更に対する耐性（クライアント層のみ修正で対応可能）<br>テストのしやすさ（各層を独立してテスト可能）<br>可読性の向上<br>改善点:</p>
<p>App.javaが表示ロジックを多く含み肥大化している<br>→ 専用のViewクラスを作成すべき<br>エラーハンドリングが不十分<br>→ API失敗時のリトライ機構，ユーザーへのエラーメッセージ改善<br>5.2.2 データ構造とアルゴリズムの評価<br>データ構造:</p>
<p>List<MoveAnalysis>の使用は適切．順序が重要で，サイズが小さい（最大15要素）<br>long型の採用により数値オーバーフロー問題を回避<br>MoveAnalysisクラスが定石外れ/範囲外をbooleanフラグで区別しているのは明快<br>アルゴリズム:</p>
<p>定石判定の貪欲法（最多ゲーム数を選択）は簡潔で効率的<br>計算量O(n×m)は実用上問題なし（n≤15, m≤10程度）<br>効率面の改善案:</p>
<p>API呼び出しのキャッシング: 同じ局面への複数回の問い合わせを避ける<br>並列処理: 定石判定とエンジン評価を並行実行<br>バッチ処理: 複数対局を一度に分析<br>5.2.3 リソース選択の評価<br>Lichess API:</p>
<p>無料で制限が緩い（適切）<br>公開対局のみという制約はあるが，学習目的では問題なし<br>Opening Explorer API:</p>
<p>マスターゲーム・Lichessゲーム両方のデータベースを持つ（適切）<br>ゲーム数のフィルタリングが可能（適切）<br>Chess Engine API:</p>
<p>[TODO: 使用したエンジンAPIについて評価]<br>代替案の検討:</p>
<p>Stockfish等のローカルエンジンを使えばAPI制約がない<br>ただし計算時間とセットアップの手間が増加<br>5.3 その他<br>5.3.1 ユーザビリティ<br>コマンドライン実行は手軽だが，一般ユーザーには敷居が高い<br>GUI版やWeb版があれば利便性が向上する<br>5.3.2 拡張性<br>現在の設計は拡張しやすい構造になっている：<br>新しい分析機能の追加が容易（サービス層にメソッド追加）</p>
<ol start="6">
<li>おわりに<br>本プログラムは，Lichess対局から定石外れを自動検出し，学習を支援するシステムとして，当初の目的を達成できた．<br>特に「定石外れ」と「定石範囲外」を区別することで，ユーザーは自分の責任範囲を明確に理解でき，効果的な学習が可能となった．</li>
</ol>
<p>今後の展開として，以下が考えられる：</p>
<p>Web UI化によるアクセス性の向上<br>複数対局の一括分析・統計機能<br>定石の傾向分析とレコメンデーション<br>ユーザー間での定石学習の共有機能<br>チェスの上達には定石学習が不可欠であり，本システムがその一助となることを期待する．</p>
<p>感想</p>
<p>とても大変だった．<br>実際に自分の対局を分析してみて気づいたこと</p>
<p>など<br>参考文献<br>Lichess API Documentation<br>URL: <a href="https://lichess.org/api">https://lichess.org/api</a><br>概要: Lichess APIの公式ドキュメント．対局データ取得APIの仕様について記載．</p>
<p>Lichess Opening Explorer API<br>URL: <a href="https://github.com/lichess-org/lila-openingexplorer">https://github.com/lichess-org/lila-openingexplorer</a><br>概要: Opening Explorer APIのGitHubリポジトリ．定石データベースの構造とAPI仕様について説明．</p>
<p>Standard Algebraic Notation (SAN)<br>URL: <a href="https://en.wikipedia.org/wiki/Algebraic_notation_(chess)">https://en.wikipedia.org/wiki/Algebraic_notation_(chess)</a><br>概要: チェスの標準表記法についての解説．本プログラムで手の表記に使用．</p>
<p>Forsyth-Edwards Notation (FEN)<br>URL: <a href="https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation">https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation</a><br>概要: チェス局面を文字列で表現する形式の解説．</p>
<p>Gson User Guide<br>URL: <a href="https://github.com/google/gson/blob/master/UserGuide.md">https://github.com/google/gson/blob/master/UserGuide.md</a><br>概要: Gsonライブラリのユーザーガイド．JSON解析の実装方法について記載．</p>
<p>chesslib - Java Chess Library<br>URL: <a href="https://github.com/bhlangonijr/chesslib">https://github.com/bhlangonijr/chesslib</a><br>概要: Javaでチェスのロジックを扱うためのライブラリ．盤面管理と手の検証に使用．</p>
<p>[TODO: Chess Engine APIのドキュメント]</p>
<p>付録<br>A. クラス一覧<br>[TODO: 全クラスの簡単な説明リスト]</p>
<p>B. API呼び出しの詳細<br>[TODO: 具体的なリクエスト・レスポンス例]</p>
<p>C. ソースコードリポジトリ<br>[TODO: GitHubなどのリンク]</p>
