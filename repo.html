<h1>チェス定石トレーナー：Lichess対局の定石分析システム</h1>
<p><strong>学籍番号</strong>: [23FR036]<br><strong>氏名</strong>: [加藤 将貴]</p>
<h2>https://github.com/scripthropus/data-engineering</h2>
<h3>アップロードのミスで動作しない場合はクローンをお願いします．</h3>
<hr>
<h2>1. はじめに</h2>
<h3>1.1 背景</h3>
<ul>
<li>チェスの上達には定石（オープニング）の学習が不可欠</li>
<li>自分の対局のどこで定石から外れたか気づきにくい</li>
</ul>
<h4>チェスの定石トレーナーを作成した理由について</h4>
<p>チェスの定石トレーナーを作成した理由は，チェスの序盤の学習を<br>簡単にするためである．<br>私は趣味で将棋を指している，その延長でチェスも指すようになった．<br>チェスの序盤は定石が複雑で覚える内容が多いため，<br>これを効率的に学習できる環境が必要と考えた．</p>
<h3>1.2 目的</h3>
<p>本プログラムは，Lichess（オンラインチェスプラットフォーム）で行われた対局を分析し，<br>プレイヤーが定石から外れた箇所を検出して学習を支援することを目的とする．</p>
<h3>1.3 概要</h3>
<p>本システムは以下の機能を提供する：</p>
<ul>
<li>Lichess APIから対局データを取得</li>
<li>Opening Explorer APIから定石データを取得</li>
<li>プレイヤーの手が定石内か判定（100ゲーム以上を閾値とする）</li>
<li>定石外れの場合，正しい定石手と相手の最善手を提示</li>
<li>定石手順を最大15手まで表示</li>
</ul>
<hr>
<h2>2. プログラムで使用するデータとデータ記述言語</h2>
<h3>2.1 Web API</h3>
<p>本プログラムは3つのWeb APIを利用している．</p>
<h4>2.1.1 Lichess API</h4>
<p>プレイヤーの対局データを取得するためのAPI．NDJSON形式でゲーム情報を返す．</p>
<h4>2.1.2 Opening Explorer API</h4>
<p>チェスの定石データベース．特定の局面における各手の統計情報（指された回数，勝率など）をJSON形式で提供する．</p>
<h4>2.1.3 Chess Engine API</h4>
<p>チェスエンジンを利用して，特定局面での最善手を計算するAPI．</p>
<h3>2.2 データ記述言語とフォーマット</h3>
<h4>JSON (JavaScript Object Notation)</h4>
<p>全てのAPIレスポンスはJSON形式で提供される．軽量で可読性が高く，JavaのGsonライブラリで容易にパースできる．</p>
<h4>SAN (Standard Algebraic Notation)</h4>
<p>チェスの手を表記する標準形式（例：<code>Nf3</code>, <code>e4</code>, <code>O-O</code>）．人間にとって読みやすい．</p>
<h4>FEN (Forsyth-Edwards Notation)</h4>
<p>チェス盤の局面を1行の文字列で表現する形式．局面の保存・復元に使用．</p>
<h2>3. プログラムの設計と実装</h2>
<h3>3.1 実現した機能</h3>
<p>本アプリケーションは，<br>Lichess（オンラインチェスプラットフォーム）で行われた<br>自身の対局を分析し，定石から外れた箇所を検出して<br>定石の学習を支援するアプリケーションである．</p>
<h4>3.1.1 基本機能</h4>
<ol>
<li><strong>対局データの取得</strong>: Lichessユーザー名を指定して最新の対局を取得(デフォルトは自分のユーザー名であるdef-e)</li>
<li><strong>プレイヤーカラーの自動検出</strong>: 対局データから白番・黒番を自動判別</li>
<li><strong>定石判定</strong>: 各手が定石か判定</li>
<li><strong>定石外れの検出</strong>: 最初に定石から外れた手を特定</li>
<li><strong>推奨手の表示</strong>: 定石外れ時に正しい定石手を提示</li>
<li><strong>咎められる手表示</strong>: 相手がどう対応すべきかを表示</li>
<li><strong>定石手順の表示</strong>: 対局の定石部分を最大15手まで表示</li>
</ol>
<h4>3.1.2 高度な機能</h4>
<ul>
<li><strong>定石範囲外と定石外れの区別</strong><ul>
<li>定石外れ：定石が存在するのに別の手を指した</li>
<li>定石範囲外：その局面に定石が存在しない（100ゲーム以上の手がない）</li>
</ul>
</li>
</ul>
<h4>3.1.3 使用方法</h4>
<pre><code class="language-bash"># コンパイル
mvn clean compile

# 実行（ユーザー名を指定）
mvn exec:java -Dexec.mainClass=&quot;jp.ac.dendai.App&quot; -Dexec.args=&quot;[username]&quot;

# 実行例
mvn exec:java -Dexec.mainClass=&quot;jp.ac.dendai.App&quot; -Dexec.args=&quot;def-e&quot;
</code></pre>
<h4>3.1.4 前提条件と制約</h4>
<ul>
<li>インターネット接続が必要（API利用のため）</li>
<li>分析対象はLichessの公開対局のみ</li>
<li>定石判定は100ゲーム以上を閾値とする</li>
<li>最大で最初の15手（チェスの数え方，白番と黒番の手セットで1手）のみを分析対象とする</li>
</ul>
<h3>3.2 システムが利用するリソース</h3>
<p>リソース1: Lichess Games API<br>名称: Lichess Games Export API<br>概要: ユーザーの対局データをエクスポートするAPI<br>利用目的: 対局データの取得<br>URL: <a href="https://lichess.org/api/games/user/%7Busername%7D">https://lichess.org/api/games/user/{username}</a><br>形式: Web API (NDJSON形式)<br>リクエストパラメータ:</p>
<ul>
<li>username: Lichessユーザー名（パスパラメータ）</li>
<li>opeing: オープニング情報を含める</li>
</ul>
<p>レスポンス構造:</p>
<ul>
<li>形式: NDJSON (Newline Delimited JSON)</li>
<li>各行が1つのゲームオブジェクトを表すJSON</li>
<li>主要フィールド:<ul>
<li>id: ゲームID</li>
<li>players: プレイヤー情報（white/black、user、rating）</li>
<li>moves: 指し手の列（SAN形式、スペース区切り）</li>
<li>opening: オープニング情報（eco、name、ply）</li>
<li>clock: 持ち時間設定</li>
<li>status: ゲーム終了状態</li>
<li>winner: 勝者の色</li>
</ul>
</li>
</ul>
<pre><code class="language-JSON">{&quot;id&quot;:&quot;tVyiD7v5&quot;,&quot;rated&quot;:true,&quot;variant&quot;:&quot;standard&quot;,&quot;speed&quot;:&quot;blitz&quot;,&quot;perf&quot;:&quot;blitz&quot;,&quot;createdAt&quot;:1766986122983,&quot;lastMoveAt&quot;:1766986736483,&quot;status&quot;:&quot;resign&quot;,&quot;source&quot;:&quot;pool&quot;,&quot;players&quot;:{&quot;white&quot;:{&quot;user&quot;:{&quot;name&quot;:&quot;icedmilktea&quot;,&quot;id&quot;:&quot;icedmilktea&quot;},&quot;rating&quot;:1427,&quot;ratingDiff&quot;:4},&quot;black&quot;:{&quot;user&quot;:{&quot;name&quot;:&quot;def-e&quot;,&quot;id&quot;:&quot;def-e&quot;},&quot;rating&quot;:1378,&quot;ratingDiff&quot;:-14}},&quot;winner&quot;:&quot;white&quot;,&quot;opening&quot;:{&quot;eco&quot;:&quot;D02&quot;,&quot;name&quot;:&quot;Queen&#39;s Pawn Game: Symmetrical Variation, Pseudo-Catalan&quot;,&quot;ply&quot;:5},&quot;moves&quot;:&quot;d4 d5 Nf3 Nf6 g3 e6 Bg2 Bd6 O-O O-O c4 dxc4 Nc3 a6 e4 Bb4 Bg5 h6 Bxf6 Qxf6 e5 Qd8 Nd2 Qxd4 Rc1 Nc6 Nf3 Qxd1 Rfxd1 Bxc3 Rxc3 Na5 a4 b5 axb5 axb5 Ra3 b4 Ra4 Bd7 Rxd7 c3 Rxb4 c2 Rxc7 Nc4 Rbxc4 Ra1+ Bf1 Rd8 Rxc2 Rdd1 Nd2&quot;,&quot;clock&quot;:{&quot;initial&quot;:300,&quot;increment&quot;:3,&quot;totalTime&quot;:420}}
</code></pre>
<p>リソース2: Opening Explorer API<br>名称: Lichess Opening Explorer API<br>概要: チェス定石データベース．局面ごとの手の統計を提供<br>利用目的: 各局面での定石手とゲーム数の取得<br>URL: <a href="https://explorer.lichess.ovh/lichess">https://explorer.lichess.ovh/lichess</a><br>形式: Web API (JSON形式)</p>
<p>リクエストパラメータ:</p>
<ul>
<li>variant: ゲームバリアント（デフォルト: standard）</li>
<li>speeds: タイムコントロール（カンマ区切り、例: blitz,rapid,classical）</li>
<li>ratings: レーティング範囲（カンマ区切り、例: 1600,1800,2000,2200,2500）</li>
<li>play: 現在の局面までの手順（UCI形式、カンマ区切り、例: e2e4,e7e5）</li>
</ul>
<p>レスポンス構造:</p>
<ul>
<li>形式: JSON</li>
<li>主要フィールド:<ul>
<li>white: 白勝利のゲーム数</li>
<li>draws: 引き分けのゲーム数</li>
<li>black: 黒勝利のゲーム数</li>
<li>moves: この局面から可能な手の配列<ul>
<li>uci: UCI形式の手</li>
<li>san: SAN形式の手</li>
<li>averageRating: この手が指された対局の平均レーティング</li>
<li>white/draws/black: この手における白勝利/引き分け/黒勝利のゲーム数</li>
<li>opening: オープニング情報（eco、name）</li>
</ul>
</li>
<li>recentGames: 最近の対局のサンプル</li>
<li>opening: 現在の局面のオープニング情報</li>
</ul>
</li>
</ul>
<pre><code class="language-JSON">{&quot;white&quot;:250702783,&quot;draws&quot;:21910923,&quot;black&quot;:220445454,&quot;moves&quot;:[{&quot;uci&quot;:&quot;g1f3&quot;,&quot;san&quot;:&quot;Nf3&quot;,&quot;averageRating&quot;:1836,&quot;white&quot;:161214378,&quot;draws&quot;:14787883,&quot;black&quot;:141595436,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C40&quot;,&quot;name&quot;:&quot;King&#39;s Knight Opening&quot;}},{&quot;uci&quot;:&quot;f1c4&quot;,&quot;san&quot;:&quot;Bc4&quot;,&quot;averageRating&quot;:1789,&quot;white&quot;:24827664,&quot;draws&quot;:2077492,&quot;black&quot;:22392779,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C23&quot;,&quot;name&quot;:&quot;Bishop&#39;s Opening&quot;}},{&quot;uci&quot;:&quot;f2f4&quot;,&quot;san&quot;:&quot;f4&quot;,&quot;averageRating&quot;:1840,&quot;white&quot;:23213554,&quot;draws&quot;:1602798,&quot;black&quot;:20085641,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C30&quot;,&quot;name&quot;:&quot;King&#39;s Gambit&quot;}},{&quot;uci&quot;:&quot;d2d4&quot;,&quot;san&quot;:&quot;d4&quot;,&quot;averageRating&quot;:1837,&quot;white&quot;:15358140,&quot;draws&quot;:1122647,&quot;black&quot;:12423983,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;Center Game&quot;}},{&quot;uci&quot;:&quot;b1c3&quot;,&quot;san&quot;:&quot;Nc3&quot;,&quot;averageRating&quot;:1842,&quot;white&quot;:14410523,&quot;draws&quot;:1236777,&quot;black&quot;:12273113,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C25&quot;,&quot;name&quot;:&quot;Vienna Game&quot;}},{&quot;uci&quot;:&quot;d2d3&quot;,&quot;san&quot;:&quot;d3&quot;,&quot;averageRating&quot;:1761,&quot;white&quot;:4189072,&quot;draws&quot;:408439,&quot;black&quot;:4274470,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: Leonardis Variation&quot;}},{&quot;uci&quot;:&quot;d1h5&quot;,&quot;san&quot;:&quot;Qh5&quot;,&quot;averageRating&quot;:1743,&quot;white&quot;:1729664,&quot;draws&quot;:156850,&quot;black&quot;:1550308,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: Wayward Queen Attack&quot;}},{&quot;uci&quot;:&quot;c2c3&quot;,&quot;san&quot;:&quot;c3&quot;,&quot;averageRating&quot;:1788,&quot;white&quot;:1574481,&quot;draws&quot;:129747,&quot;black&quot;:1518942,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: MacLeod Attack&quot;}},{&quot;uci&quot;:&quot;d1f3&quot;,&quot;san&quot;:&quot;Qf3&quot;,&quot;averageRating&quot;:1722,&quot;white&quot;:971065,&quot;draws&quot;:87905,&quot;black&quot;:959904,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game: Napoleon Attack&quot;}},{&quot;uci&quot;:&quot;c2c4&quot;,&quot;san&quot;:&quot;c4&quot;,&quot;averageRating&quot;:1815,&quot;white&quot;:833206,&quot;draws&quot;:84003,&quot;black&quot;:787154,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;English Opening: The Whale&quot;}},{&quot;uci&quot;:&quot;g2g3&quot;,&quot;san&quot;:&quot;g3&quot;,&quot;averageRating&quot;:1806,&quot;white&quot;:570977,&quot;draws&quot;:52103,&quot;black&quot;:549309,&quot;game&quot;:null,&quot;opening&quot;:null},{&quot;uci&quot;:&quot;b2b3&quot;,&quot;san&quot;:&quot;b3&quot;,&quot;averageRating&quot;:1766,&quot;white&quot;:347361,&quot;draws&quot;:30938,&quot;black&quot;:392430,&quot;game&quot;:null,&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Opening&quot;}}],&quot;recentGames&quot;:[{&quot;uci&quot;:&quot;g1f3&quot;,&quot;id&quot;:&quot;pQNSVFp5&quot;,&quot;winner&quot;:null,&quot;speed&quot;:&quot;rapid&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;Para85&quot;,&quot;rating&quot;:1912},&quot;white&quot;:{&quot;name&quot;:&quot;gg264&quot;,&quot;rating&quot;:1927},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;},{&quot;uci&quot;:&quot;f1c4&quot;,&quot;id&quot;:&quot;ijErMjCS&quot;,&quot;winner&quot;:&quot;white&quot;,&quot;speed&quot;:&quot;blitz&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;NurikTurganbek&quot;,&quot;rating&quot;:1999},&quot;white&quot;:{&quot;name&quot;:&quot;Yarlaxle&quot;,&quot;rating&quot;:1972},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;},{&quot;uci&quot;:&quot;g1f3&quot;,&quot;id&quot;:&quot;tcSaFYFc&quot;,&quot;winner&quot;:&quot;black&quot;,&quot;speed&quot;:&quot;blitz&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;lunamarta&quot;,&quot;rating&quot;:1963},&quot;white&quot;:{&quot;name&quot;:&quot;Jovudza&quot;,&quot;rating&quot;:1916},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;},{&quot;uci&quot;:&quot;g1f3&quot;,&quot;id&quot;:&quot;BqwxwJ0t&quot;,&quot;winner&quot;:&quot;white&quot;,&quot;speed&quot;:&quot;classical&quot;,&quot;mode&quot;:&quot;rated&quot;,&quot;black&quot;:{&quot;name&quot;:&quot;rezav&quot;,&quot;rating&quot;:1708},&quot;white&quot;:{&quot;name&quot;:&quot;goscpiotrek&quot;,&quot;rating&quot;:1830},&quot;year&quot;:2025,&quot;month&quot;:&quot;2025-11&quot;}],&quot;topGames&quot;:[],&quot;opening&quot;:{&quot;eco&quot;:&quot;C20&quot;,&quot;name&quot;:&quot;King&#39;s Pawn Game&quot;}}
</code></pre>
<p>リソース3: Chess Engine API<br>名称: Chess-API.com<br>概要: チェスエンジンによる局面評価・最善手計算<br>利用目的: 定石外れ後の相手の最善手を取得（咎められてしまう手の計算）<br>URL: <a href="https://chess-api.com/v1">https://chess-api.com/v1</a><br>形式: Web API (JSON形式)<br>リクエストパラメータ:</p>
<ul>
<li>fen: 局面のFEN表記（必須）</li>
<li>depth: 探索深度（最大18、デフォルト12）</li>
<li>variants: 評価する変化手数（最大5、デフォルト1）</li>
<li>maxThinkingTime: 最大思考時間（最大100ms、デフォルト50ms）</li>
</ul>
<p>レスポンス構造:</p>
<ul>
<li>形式: JSON</li>
<li>主要フィールド:<ul>
<li>type: レスポンスタイプ（move / bestmove / info）</li>
<li>eval: 評価値（負の値は黒有利）</li>
<li>move: 最善手（UCI形式）</li>
<li>san: 最善手（SAN形式）</li>
<li>depth: 探索深度</li>
<li>continuationArr: 推奨される続きの手順</li>
<li>mate: 詰みまでの手数（nullまたは整数）</li>
<li>winChance: 勝率（0-100%）</li>
<li>text: 評価の説明文</li>
</ul>
</li>
</ul>
<pre><code class="language-JSON">{
  &quot;text&quot;: &quot;Move e2 → e4 (e4): [0.29]. The game is balanced. Depth 12.&quot;,
  &quot;captured&quot;: false,
  &quot;promotion&quot;: false,
  &quot;isCapture&quot;: false,
  &quot;isPromotion&quot;: false,
  &quot;isCastling&quot;: false,
  &quot;fen&quot;: &quot;rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1&quot;,
  &quot;type&quot;: &quot;bestmove&quot;,
  &quot;depth&quot;: 12,
  &quot;move&quot;: &quot;e2e4&quot;,
  &quot;eval&quot;: 0.29,
  &quot;centipawns&quot;: &quot;29&quot;,
  &quot;mate&quot;: null,
  &quot;continuationArr&quot;: [
    &quot;e7e5&quot;,
    &quot;g1f3&quot;,
    &quot;b8c6&quot;,
    &quot;d2d4&quot;,
    &quot;e5d4&quot;,
    &quot;f3d4&quot;,
    &quot;g8f6&quot;,
    &quot;d4c6&quot;,
    &quot;b7c6&quot;,
    &quot;f1d3&quot;,
    &quot;d7d5&quot;,
    &quot;e4e5&quot;,
    &quot;f6d7&quot;
  ],
  &quot;debug&quot;: &quot;info depth 12 seldepth 26 multipv 1 score cp 29 nodes 334092 nps 30372000 hashfull 16 tbhits 0 time 11 pv e2e4 e7e5 g1f3 b8c6 d2d4 e5d4 f3d4 g8f6 d4c6 b7c6 f1d3 d7d5 e4e5 f6d7&quot;,
  &quot;winChance&quot;: 52.66697440308632,
  &quot;taskId&quot;: &quot;yo6lt5tc1&quot;,
  &quot;turn&quot;: &quot;w&quot;,
  &quot;color&quot;: &quot;w&quot;,
  &quot;piece&quot;: &quot;p&quot;,
  &quot;from&quot;: &quot;e2&quot;,
  &quot;to&quot;: &quot;e4&quot;,
  &quot;san&quot;: &quot;e4&quot;,
  &quot;flags&quot;: &quot;b&quot;,
  &quot;lan&quot;: &quot;e2e4&quot;,
  &quot;fromNumeric&quot;: &quot;52&quot;,
  &quot;toNumeric&quot;: &quot;54&quot;,
  &quot;continuation&quot;: [
    {
      &quot;from&quot;: &quot;e7&quot;,
      &quot;to&quot;: &quot;e5&quot;,
      &quot;fromNumeric&quot;: &quot;57&quot;,
      &quot;toNumeric&quot;: &quot;55&quot;
    },
    {
      &quot;from&quot;: &quot;g1&quot;,
      &quot;to&quot;: &quot;f3&quot;,
      &quot;fromNumeric&quot;: &quot;71&quot;,
      &quot;toNumeric&quot;: &quot;63&quot;
    }
  ]
}
</code></pre>
<h1>3.3 プログラムの構成</h1>
<h2>3.3.1 全体構成</h2>
<p>本プログラムは以下の3つの層で構成される：</p>
<ol>
<li><strong>UI層（App.java）</strong>: ユーザーとのインタラクション，結果表示</li>
<li><strong>サービス層（OpeningTrainerService.java）</strong>: 定石判定のビジネスロジック</li>
<li><strong>API層（api/）</strong>: 外部リソースとの通信</li>
</ol>
<h2>3.3.2 主要クラスの役割</h2>
<h3>App.java</h3>
<ul>
<li>コマンドライン引数の処理</li>
<li>Lichess APIから対局データ取得</li>
<li>解析結果の整形・表示</li>
</ul>
<h3>OpeningTrainerService.java</h3>
<ul>
<li>対局の定石判定ロジック（<code>analyzeGame()</code>）</li>
<li>定石手順の取得（<code>getTheoryLine()</code>）</li>
<li>100局以上のデータがある手を「定石」と判定</li>
</ul>
<h3>LichessApiClient.java</h3>
<ul>
<li>Lichess Game Export APIとの通信</li>
<li>対局データ（JSON）の取得</li>
</ul>
<h3>OpeningExplorerClient.java</h3>
<ul>
<li>Lichess Masters Databaseとの通信</li>
<li>各局面での定石手の統計情報取得</li>
</ul>
<h3>ChessEngineClient.java</h3>
<ul>
<li>Stockfish APIとの通信</li>
<li>逸脱手に対する最善応手の取得</li>
</ul>
<h3>PositionTracker.java</h3>
<ul>
<li>チェス盤面の状態管理</li>
<li>手の適用とUCI形式への変換</li>
<li>chesslib ライブラリを使用</li>
</ul>
<h3>モデルクラス（model/）</h3>
<ul>
<li>Game, MoveAnalysis, OpeningMove等</li>
<li>データの格納とアクセス</li>
</ul>
<h2>3.3.3 処理の流れ</h2>
<ol>
<li>ユーザー名から対局取得 (LichessApiClient)</li>
<li>1手ずつ定石判定 (OpeningTrainerService)<ul>
<li>各局面で定石手取得 (OpeningExplorerClient)</li>
<li>逸脱時はエンジン最善手取得 (ChessEngineClient)</li>
</ul>
</li>
<li>正しい定石手順を構築</li>
<li>結果表示 (App)</li>
</ol>
<h3>3.5 その他の工夫点</h3>
<h4>3.5.1 数値オーバーフロー対策</h4>
<p>Opening Explorer APIのゲーム数は最大35億を超える場合があり，Java のint型（最大21億）では表現できない．<br>そのためlong型（最大922京）を使用した．</p>
<h4>3.5.2 プレイヤーカラー自動検出</h4>
<p>ユーザーが白番・黒番のどちらで対局したかを自動判別することで，<br>ユーザビリティを向上させた．</p>
<h4>3.5.3 定石外れと定石範囲外の区別</h4>
<p>定石外れ: ユーザーのミス → 学習すべき箇所<br>定石範囲外: 定石が尽きた → ミスではない<br>この区別により，ユーザーは自分の責任範囲を明確に理解できる．</p>
<h4>3.5.4 Top Opening Movesのフィルタリング</h4>
<p>100ゲーム以上の手のみを表示（最大3個）することで，信頼性の高い情報のみを提供．</p>
<ol start="4">
<li>実験<br>4.1 実験条件<br>Gson: 2.10.1<br>chesslib: 1.3.3</li>
</ol>
<p>ユーザー名: def-e<br>対局数: 1（最新対局）<br>対局形式: ブリッツ/ラピッド/クラシカル（全て含む）<br>分析範囲: 開始から15手（30ply）</p>
<p>4.2 実験結果<br>4.2.1 成功例：定石範囲外の検出</p>
<pre><code class="language-bash">$ mvn exec:java -Dexec.mainClass=&quot;jp.ac.dendai.App&quot;
[INFO] Scanning for projects...
[INFO]
[INFO] -------------------------&lt; jp.ac.dendai:chess &gt;-------------------------
[INFO] Building chess 1.0-SNAPSHOT
[INFO]   from pom.xml
[INFO] --------------------------------[ jar ]---------------------------------
[INFO]
[INFO] --- exec:3.6.3:java (default-cli) @ chess ---
=== チェス定石トレーナー ===
ユーザー: def-e の対局を取得中

対局ID: hQScKKY0
オープニング: Queen&#39;s Pawn Game: London System

白: decubs (1316)
黒: def-e (1364)

対局を解析中

=== 序盤解析結果 ===

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
3...手目 Black: Nc6
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
? この手は定石から外れています！

? 推奨手: c5

? 主要な定石手:
   c5 - 4522 局
   e6 - 1568 局
   Bf5 - 641 局

??  相手の最善応手:
   e3

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
まとめ:
  定石に沿った手数: 2 手
  結果: 3手目で逸脱
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

? 定石手順:

   1. d4 d5
   2. Bf4 Nf6
   3. Nf3 c5
   4. e3 Nc6
   5. Nbd2 Qb6
   6. dxc5 Qxb2
   7. Rb1 Qc3
   8. Bb5 e6
   9. O-O Be7
   10. e4 O-O
   11. e5 Nd7
   12. Nb3 Qb4
   13. Nbd4 Qxc5
   14. Re1

   (定石は14手目までです)

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  24.423 s
[INFO] Finished at: 2026-01-11T21:29:00+09:00
[INFO] ------------------------------------------------------------------------
</code></pre>
<p><strong>結果の解釈:</strong></p>
<ul>
<li>プレイヤー（黒番）は2手目まで定石通りに指した（<code>d5</code>, <code>Nf6</code>）</li>
<li>3手目で <code>Nc6</code> を指したが，これは定石から逸脱している</li>
<li>Masters Databaseでは <code>c5</code> が4522局で最も多く指されており，これが推奨手として表示された</li>
<li>他の定石手として <code>e6</code>（1568局），<code>Bf5</code>（641局）も提示された</li>
<li>逸脱手に対する相手の最善応手として <code>e3</code> が表示された</li>
<li>定石手順では，実際に指された <code>d4 d5 Bf4 Nf6</code> の後，正しい定石の続き <code>c5</code> 以降が13手目まで表示された</li>
<li>これにより，プレイヤーは自分がどこで定石から外れたか，正しい手順は何だったかを確認できる</li>
</ul>
<h3>3.5 その他の工夫点</h3>
<h4>3.5.1 数値オーバーフロー対策</h4>
<p>Opening Explorer APIのゲーム数は最大35億を超える場合があり，Java のint型（最大21億）では表現できない．<br>そのためlong型（最大922京）を使用した．</p>
<h4>3.5.2 プレイヤーカラー自動検出</h4>
<p>ユーザーが白番・黒番のどちらで対局したかを自動判別することで，<br>ユーザビリティを向上させた．</p>
<h4>3.5.3 定石外れと定石範囲外の区別</h4>
<p>定石外れ: ユーザーのミス → 学習すべき箇所<br>定石範囲外: 定石が尽きた → ミスではない<br>この区別により，ユーザーは自分の責任範囲を明確に理解できる．</p>
<h4>3.5.4 Top Opening Movesのフィルタリング</h4>
<p>100ゲーム以上の手のみを表示（最大3個）することで，信頼性の高い情報のみを提供．</p>
<h2>5. 考察</h2>
<h3>5.1 機能</h3>
<p><strong>実現した機能の適切性:</strong></p>
<p>定石判定機能は基本的に適切に動作している．<br>100局以上を定石の基準としたことで，マイナーな変化を排除し，信頼性の高い定石のみを対象とできた．<br>逸脱時に推奨手と相手の最善応手を提示する機能は，学習目的として有用である．</p>
<p><strong>改良点:</strong></p>
<ul>
<li>現在は最新の1局のみを解析対象としているが，複数局を一括解析し，定石逸脱の傾向を統計的に分析する機能があると有用</li>
</ul>
<h3>5.2 実現方法</h3>
<p><strong>プログラム構造:</strong></p>
<p>API層，サービス層，UI層の3層構造は適切だった．各クラスの責務が明確で保守性が高い．特に <code>PositionTracker</code> によって盤面管理を抽象化できたことで，サービス層のロジックが簡潔になった．</p>
<p><strong>データ構造とアルゴリズム:</strong></p>
<p>1手ずつ順次処理する単純なアルゴリズムだが，定石判定という問題の性質上これで十分である．<code>List&lt;MoveAnalysis&gt;</code> による解析結果の保持は扱いやすい．</p>
<p><strong>効率面:</strong></p>
<p>各手ごとにAPI呼び出しを行うため，ネットワーク遅延が累積する．<br>ただし，個人の学習用途では現状の速度（20-30秒程度）で実用上問題ない．</p>
<p><strong>リソースの選択:</strong></p>
<ul>
<li><strong>Lichess Masters Database</strong>: グランドマスターの対局データを基準とすることで信頼性の高い定石判定が可能</li>
<li><strong>Lichess Game Export API</strong>: ユーザーの対局データを簡単に取得でき，適切</li>
<li><strong>chesslib</strong>: 盤面管理を自前で実装する必要がなく，バグのリスクを低減できた</li>
<li><strong>Chess Engine API</strong>: stock fishというチェスエンジンを使うことができ，これはローカルでも動作させることは可能だが，外部のマシンで動かすことにより手元のデバイスの性能にとらわれない実装とすることができた．</li>
</ul>
<p>全てのリソースは目的に対して適切であり，有効に活用できた．</p>
<h3>5.3 その他</h3>
<p>定石の定義を「100局以上」としたが，この閾値は調整可能にすべきだった．<br>マイナーな定石に対しては100局未満であっても，masterのデータベースに残っているならば，<br>定石手順として扱っても良かったかもしれない．</p>
<h2>6. おわりに</h2>
<p>本プログラムは，Lichessの複数のAPIとStockfishを組み合わせることで，<br>チェスの定石学習を支援するツールを実現した．自分の対局を振り返り，どこで定石から外れたか，正しい手順は何だったかを即座に確認できる点で実用的である．</p>
<p>今後の展開として，以下が考えられる：</p>
<ul>
<li>複数局の統計分析機能</li>
<li>定石の「弱点」（よく逸脱する箇所）の自動検出</li>
<li>練習問題生成機能（定石クイズ）</li>
</ul>
<h2>感想</h2>
<p>定石の判定に悩み，単純な実装にする方法に落ち着いた．複雑だった．<br>実際に動作するマッシュアップを完成させることができ，達成感はあるが，<br>自動実行してくれるなら，使ってもよいかなと思えるくらいのプログラムにはなった．</p>

<p>参考文献<br>Lichess API Documentation<br>URL: <a href="https://lichess.org/api">https://lichess.org/api</a><br>概要: Lichess APIの公式ドキュメント．対局データ取得APIの仕様について記載．</p>
<p>Lichess Opening Explorer API<br>URL: <a href="https://github.com/lichess-org/lila-openingexplorer">https://github.com/lichess-org/lila-openingexplorer</a><br>概要: Opening Explorer APIのGitHubリポジトリ．定石データベースの構造とAPI仕様について説明．</p>
<p>Standard Algebraic Notation (SAN)<br>URL: <a href="https://en.wikipedia.org/wiki/Algebraic_notation_(chess)">https://en.wikipedia.org/wiki/Algebraic_notation_(chess)</a><br>概要: チェスの標準表記法についての解説．本プログラムで手の表記に使用．</p>
<p>Forsyth-Edwards Notation (FEN)<br>URL: <a href="https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation">https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation</a><br>概要: チェス局面を文字列で表現する形式の解説．</p>
<p>Gson User Guide<br>URL: <a href="https://github.com/google/gson/blob/master/UserGuide.md">https://github.com/google/gson/blob/master/UserGuide.md</a><br>概要: Gsonライブラリのユーザーガイド．JSON解析の実装方法について記載．</p>
<p>chesslib - Java Chess Library<br>URL: <a href="https://github.com/bhlangonijr/chesslib">https://github.com/bhlangonijr/chesslib</a><br>概要: Javaでチェスのロジックを扱うためのライブラリ．盤面管理と手の検証に使用．</p>
<p>Chess Engine APIのドキュメント<br>URL:<a href="https://chess-api.com/">https://chess-api.com/</a></p>
